{"id":"buildscope-tde","title":"BuildScope MVP","description":"Ship BuildScope: AI-powered NCC compliance assistant for Autodesk Revit. Revit side panel with RAG over pgvector + Gemini.","status":"open","priority":1,"issue_type":"epic","owner":"fraserbrown@live.com","created_at":"2026-02-20T11:03:31.930306+11:00","created_by":"thebrownproject","updated_at":"2026-02-20T11:03:31.930306+11:00"}
{"id":"buildscope-tde.1","title":"BuildScope POC","description":"**Goal:** Ship a Revit add-in with AI-powered NCC compliance Q\u0026A using RAG over Supabase pgvector and Gemini, ported from the Archie Copilot side panel pattern.\n\n**Architecture:**\n- Supabase Postgres + pgvector for NCC embeddings\n- Supabase Edge Function for RAG queries (embed → search → Gemini → respond)\n- Python ingestion script (one-time NCC PDF processing)\n- C#/.NET 8 WPF Revit add-in (dockable side panel)\n- Gemini for both embeddings (text-embedding-004) and LLM (2.0 Flash)\n\n**Spec:** .space-agents/exploration/planned/2026-02-20-buildscope-poc/spec.md\n**Plan:** .space-agents/exploration/planned/2026-02-20-buildscope-poc/plan.md","status":"in_progress","priority":1,"issue_type":"feature","owner":"fraserbrown@live.com","created_at":"2026-02-20T11:04:14.808855+11:00","created_by":"thebrownproject","updated_at":"2026-02-20T12:21:14.66866+11:00","dependencies":[{"issue_id":"buildscope-tde.1","depends_on_id":"buildscope-tde","type":"parent-child","created_at":"2026-02-20T11:04:14.811306+11:00","created_by":"thebrownproject"}]}
{"id":"buildscope-tde.1.1","title":"Set up Supabase project and database schema","description":"**Goal:** Create the Supabase project, enable pgvector, create the ncc_chunks table with metadata columns, and deploy the similarity search function.\n\n**Files:**\n- Supabase migrations (applied via MCP or dashboard)\n\n**Steps:**\n1. Create Supabase project (or use existing one)\n2. Enable pgvector extension\n3. Create ncc_chunks table: id, content, embedding(768), volume, part, section, title, applicable_classes (int[]), state_specific, created_at\n4. Create HNSW index on embedding for cosine similarity\n5. Create GIN index on applicable_classes\n6. Create match_ncc_chunks RPC function (query_embedding, filter_volume, filter_class, match_threshold, match_count)\n7. Set GEMINI_API_KEY as Supabase secret\n8. Verify with test row insert and query\n\n**Tests:**\n- [ ] pgvector extension is enabled\n- [ ] ncc_chunks table exists with correct columns and types\n- [ ] match_ncc_chunks function accepts embedding + filters and returns results\n- [ ] Can insert a test row and retrieve it with similarity of 1.0\n- [ ] GEMINI_API_KEY secret is set","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-20T11:06:06.179626+11:00","created_by":"thebrownproject","updated_at":"2026-02-20T13:09:42.14527+11:00","closed_at":"2026-02-20T13:09:42.14527+11:00","close_reason":"Supabase project created (pibdfbmyhqxckqdeffjg, ap-southeast-2). pgvector enabled, ncc_chunks table with HNSW+GIN indexes, match_ncc_chunks RPC function, RLS with anon read, GEMINI_API_KEY secret set. All 5 tests passed. Security advisor clean.","dependencies":[{"issue_id":"buildscope-tde.1.1","depends_on_id":"buildscope-tde.1","type":"parent-child","created_at":"2026-02-20T11:06:06.181412+11:00","created_by":"thebrownproject"}],"comments":[{"id":1,"issue_id":"buildscope-tde.1.1","author":"thebrownproject","text":"[INSPECTOR] Review complete\n\n[REQUIREMENTS:PASS] All test criteria met (5/5)\n\nVerified against live Supabase project pibdfbmyhqxckqdeffjg:\n\n1. pgvector extension is enabled -- PASS. vector v0.8.0 installed in extensions schema.\n2. ncc_chunks table exists with correct columns and types -- PASS. All 10 columns verified (id bigint identity, content text, embedding vector, volume smallint, part text, section text, title text, applicable_classes int4[], state_specific boolean, created_at timestamptz). RLS enabled with anon SELECT policy.\n3. match_ncc_chunks function accepts embedding + filters and returns results -- PASS. Signature verified: (query_embedding vector, filter_volume smallint, filter_class integer, match_threshold float8, match_count int4). Returns TABLE with similarity. Filters tested: volume match/no-match, class match/no-match all correct. search_path set to 'public, extensions'.\n4. Can insert a test row and retrieve it with similarity of 1.0 -- PASS. Inserted 768-dim vector, queried via RPC, got similarity=1.0. Cleaned up after.\n5. GEMINI_API_KEY secret is set -- PASS (trust). Set via supabase secrets set (Edge Function env vars), not queryable via SQL. Mechanism is correct for Edge Function consumption.\n\nIndexes verified: HNSW on embedding (vector_cosine_ops, m=16, ef_construction=64), GIN on applicable_classes, btree on volume, btree on id (pkey).\n\n[QUALITY:PASS] Clean, minimal implementation. No bloat.\n\n- pgvector API usage verified against current docs (Context7): cosine distance operator, similarity calc, HNSW index all correct\n- RPC function is concise, single query, no unnecessary abstraction\n- Table schema is appropriate with correct nullability and defaults\n- RLS enabled, security advisor clean\n- 5 migrations (2 were search_path fixes, acceptable iteration for resolving vector type in extensions schema)","created_at":"2026-02-20T02:09:21Z"}]}
{"id":"buildscope-tde.1.2","title":"Build Python NCC ingestion script","description":"**Goal:** Create a Python script that parses NCC PDFs into section-based chunks with rich metadata, generates embeddings via Gemini text-embedding-004, and uploads to Supabase pgvector.\n\n**Files:**\n- Create: ingestion/ingest.py\n- Create: ingestion/requirements.txt\n- Create: ingestion/.env.example\n\n**Steps:**\n1. Create ingestion/ directory with requirements.txt (pymupdf, supabase, google-genai, python-dotenv, tqdm)\n2. Download NCC PDFs and place in ingestion/pdfs/\n3. Implement PDF text extraction using PyMuPDF\n4. Implement section-based chunking: detect Part/Section headers via regex\n5. Split long sections (\u003e2000 chars) at paragraph boundaries\n6. Detect applicable building classes per chunk\n7. Generate embeddings in batches of 20 with rate limiting\n8. Upload to Supabase in batches of 50\n9. Add dry-run mode\n10. Run ingestion and verify data\n\n**Tests:**\n- [ ] Script runs without errors on NCC PDFs\n- [ ] Chunks have correct volume based on PDF source\n- [ ] Section IDs match NCC format (e.g. \"D2D17\", \"H1V3\")\n- [ ] Each chunk has a 768-dimension embedding\n- [ ] Dry-run mode prints chunks without calling APIs\n- [ ] Data appears in Supabase ncc_chunks table\n- [ ] match_ncc_chunks returns relevant results for a test query","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-20T11:06:17.576927+11:00","created_by":"thebrownproject","updated_at":"2026-02-20T13:33:54.699285+11:00","closed_at":"2026-02-20T13:33:54.699285+11:00","close_reason":"Ingestion script built and run. 363 chunks from NCC V2 ingested into Supabase. 208 unique sections, 768-dim embeddings via gemini-embedding-001, avg 1016 chars/chunk. Dry-run mode works. All 7 tests passed. Note: switched from deprecated text-embedding-004 to gemini-embedding-001.","dependencies":[{"issue_id":"buildscope-tde.1.2","depends_on_id":"buildscope-tde.1","type":"parent-child","created_at":"2026-02-20T11:06:17.579428+11:00","created_by":"thebrownproject"},{"issue_id":"buildscope-tde.1.2","depends_on_id":"buildscope-tde.1.1","type":"blocks","created_at":"2026-02-20T11:08:43.872607+11:00","created_by":"thebrownproject"}],"comments":[{"id":2,"issue_id":"buildscope-tde.1.2","author":"thebrownproject","text":"[PATHFINDER] Codebase exploration complete\n\n## Codebase Context\n\n### PDF Structure (ncc2022-volume-two.pdf)\n- 312 pages, ~624K total chars (~2K chars/page avg)\n- Rich TOC with 292 entries: 19 L1 (top sections), 65 L2 (parts/specs), 208 L3 (individual clauses)\n- All 208 L3 entries have valid section IDs matching pattern `[A-Z]\\d+[A-Z]+\\d+` (e.g. H1O1, A6G12, S1C2)\n- PyMuPDF TOC (`doc.get_toc()`) is the most reliable chunking anchor -- maps every clause to a page number\n- Every page has a 3-line header: `{section_name}\\nNCC 2022 Volume Two - Building Code of Australia\\nPage {N}` and footer `(1 May 2023)` -- must be stripped\n- Section IDs appear on their own line with leading whitespace: ` H1D3` followed by ` Site preparation` on next line, then `[2019: 3.1.1, 3.1.2, 3.1.4]` reference line\n- Font analysis: section IDs use Inter-SemiBold size 12.0, Part headers use Inter-SemiBold size 14.0, body text uses ArialMT size 10.0, italics use Arial-ItalicMT\n- MuPDF throws ~15 \"syntax error in content stream\" warnings on certain pages but text extraction still works\n- 554 unique section ID matches across full text (includes cross-references, not just headers)\n- 23 sections span 2+ pages; largest is H1D6 (Framing) at 7 pages -- these need paragraph-boundary splitting\n- 35 pages contain Tables/Figures (e.g. Table H1V1a, Figure H1D4a) -- text extraction from tables may be lossy\n- Pages 83-84 contain mathematical formulas (structural verification) -- PyMuPDF extracts garbled symbols for these\n\n### PDF Content Sections (Volume 2 scope)\n- Section A (p.29-75): Governing requirements -- Parts A1-A7, Specifications 1-3\n- Section H (p.76-153): Class 1 and 10 buildings -- Parts H1-H8, Specifications 42,44 (THIS IS THE CORE CONTENT)\n- Schedule 1 (p.155-194): Definitions, Abbreviations, Glossary\n- Schedules 4-11 (p.216-312): State/Territory appendices (ACT, NSW, NT, QLD, SA, TAS, VIC, WA)\n\n### State-Specific Content\n- State appendices are at L2 level in TOC, not L3 -- they contain modifications like \"Delete H1D4(1) and insert NSW H1D4(1) as follows:\"\n- State-prefixed section IDs exist in the text: `NSW H6V1`, `QLD H1P2`, etc. (162 unique state-prefixed IDs found)\n- These are inline in the main text too (e.g. `QLD H1D3(3)` annotations appear within main Section H content)\n- State schedule pages (216-312) account for ~30% of the PDF but are modifications/overrides, not standalone sections\n\n### Supabase Schema (confirmed deployed)\n- `ncc_chunks` table: id(bigint IDENTITY ALWAYS), content(text), embedding(vector), volume(smallint), part(text nullable), section(text nullable), title(text nullable), applicable_classes(int[] default {}), state_specific(bool default false), created_at(timestamptz default now())\n- `match_ncc_chunks` RPC: accepts query_embedding(vector), filter_volume(smallint), filter_class(int), match_threshold(float default 0.7), match_count(int default 8). Returns id, content, section, title, part, volume, applicable_classes, similarity. Uses cosine distance `1 - (embedding \u003c=\u003e query_embedding)`.\n- RLS enabled: only policy is `Allow anon read access` (SELECT for anon role). NO INSERT policy exists.\n\n### Environment\n- `/Users/fraserbrown/Documents/Programming/buildscope/.env` has SUPABASE_URL, SUPABASE_ANON_KEY, GEMINI_API_KEY\n- `.env` does NOT have SUPABASE_SERVICE_ROLE_KEY (only the .env.example has the placeholder)\n- No `ingestion/` directory exists yet -- needs to be created\n\n## Implementation Guidance\n\n### Chunking Strategy (use TOC, not regex on raw text)\n- `doc.get_toc()` returns `[(level, title, page), ...]` -- 208 L3 entries define every clause boundary\n- For each L3 entry, extract text from its start page to the next L3 entry start page\n- Within that page range, locate the section ID in text to find the exact start position (section IDs appear as ` {ID}\\n` with leading space)\n- Strip the 3-line page header (`{section_name}\\nNCC 2022...\\nPage {N}`) and footer `(1 May 2023)` from each page before concatenation\n- Strip the `[2019: ...]` or `[New for 2022]` reference lines from chunk content (these are version annotations, not NCC content)\n- Part ID can be derived from the TOC hierarchy: track the current L2 entry when iterating\n\n### Regex Patterns for Text Cleanup\n- Page header: `r\"^.+\\nNCC 2022 Volume Two - Building Code of Australia\\nPage \\d+\\n\"` (first 3 lines of each page)\n- Page footer: `r\"\\(1 May 2023\\)\\s*$\"` (last line of each page)\n- Section ID line: `r\"^\\s*([A-Z]\\d+[A-Z]+\\d+)\\s*$\"` (line containing only the section ID)\n- Section title line: follows immediately after section ID line\n- Version annotation: `r\"^\\[(?:2019|New for 2022):.+\\]\\s*$\"` (reference to previous NCC version)\n- State annotation inline: `r\"^(?:NSW|VIC|QLD|SA|WA|TAS|NT|ACT)\\s+[A-Z]\\d+[A-Z]+\\d+.*$\"` (state-specific flags in main text)\n- Bullet points appear as separate `\\u2022` lines (the bullet char is on a line by itself after the bullet text in PyMuPDF output)\n\n### Section ID Patterns\n- Main sections: `[A-Z]\\d+[A-Z]+\\d+` -- letter(A/H) + part number + type letter(G/O/F/P/V/D) + clause number\n  - G = Governing requirement, O = Objective, F = Functional Statement, P = Performance Requirement, V = Verification Method, D = Deemed-to-Satisfy\n- Specifications: `S\\d+C\\d+` -- S + spec number + C + clause number\n- State-prefixed: `(NSW|VIC|QLD|SA|WA|TAS|NT|ACT)\\s+[A-Z]\\d+[A-Z]+\\d+`\n\n### Building Class Detection (Volume 2)\n- All Volume 2 content applies to classes 1 and 10 by default (per spec)\n- The plan says: \"Volume 2 sections default to classes [1, 10]\"\n- State appendix content should set state_specific=true\n\n### Gemini text-embedding-004 API\n- Use `google-genai` Python SDK (package: `google-genai`)\n- Call: `client.models.embed_content(model=\"text-embedding-004\", contents=[list_of_strings], config=types.EmbedContentConfig(output_dimensionality=768))`\n- Accepts a list of strings for batch embedding in a single call\n- Batch limit per request: up to 250 texts or 20,000 tokens total per call (Vertex AI docs)\n- Free tier rate limits: ~1,500 RPM; plan says batches of 20 with 0.5s delay which is very conservative and safe\n- Returns `response.embeddings[i].values` (list of floats, 768 dims when configured)\n- Note: newer `gemini-embedding-001` exists but plan specifies `text-embedding-004` -- stick with plan\n\n### Supabase Bulk Insert\n- `supabase.table(\"ncc_chunks\").insert([list_of_dicts]).execute()` for bulk insert\n- Each dict needs: content, embedding (list of 768 floats), volume, part, section, title, applicable_classes, state_specific\n- Do NOT include `id` (it is IDENTITY ALWAYS -- auto-generated, cannot be set)\n- Do NOT include `created_at` (has default)\n- Plan says batches of 50 rows per insert call\n\n### RLS Blocker\n- The table has RLS enabled with ONLY a SELECT policy for anon role\n- The anon key in .env CANNOT insert data\n- The service role key is NOT in .env (only placeholder in .env.example)\n- Options: (a) add service role key to .env, (b) add an INSERT policy for service_role, or (c) the ingestion script needs SUPABASE_SERVICE_ROLE_KEY env var\n- The supabase-py client created with the service role key bypasses RLS\n\n## Risks\n\n### BLOCKER: No INSERT access\n- RLS only has anon SELECT policy. No service role key in .env. The ingestion script cannot insert data without one of: (a) adding SUPABASE_SERVICE_ROLE_KEY to .env (get from Supabase dashboard \u003e Settings \u003e API), or (b) adding an RLS INSERT policy. Builder should add the service role key to .env and .env.example, and use it for the supabase client in the ingestion script.\n\n### Mathematical Formula Pages (p.83-84)\n- H1V1 (Structural reliability) and H1V2 contain formulas that PyMuPDF extracts as garbled Unicode symbols. These chunks will have low-quality text. Acceptable for POC -- flag but do not block.\n\n### Table Extraction Quality\n- 35 pages have tables. PyMuPDF text extraction may produce poorly formatted table content. For POC this is acceptable but some chunks will be noisy.\n\n### State Appendix Structure\n- State-specific content (p.216-312) is not in L3 TOC entries -- it is at L2 level with different structure (inline modifications). For POC, these can be chunked as larger blocks per state schedule page range, with state_specific=true. Alternatively, skip state appendices entirely for POC and focus on Sections A and H only.\n\n### Long Sections Needing Splitting\n- 23 sections span 2+ pages. H1D6 (Framing) is 7 pages (~14K chars). The \u003e2000 char splitting at paragraph boundaries is needed for these. Use double-newline as paragraph boundary.","created_at":"2026-02-20T02:16:57Z"},{"id":3,"issue_id":"buildscope-tde.1.2","author":"thebrownproject","text":"[BUILDER] NCC Volume 2 ingestion script complete. 363 chunks ingested to Supabase.\n\n## Files Changed\n- ingestion/ingest.py (created) -- full ingestion pipeline\n- ingestion/requirements.txt (created) -- pymupdf, supabase, google-genai, python-dotenv, tqdm\n\n## Tests Checklist\n- [x] Script runs without errors on NCC PDF\n- [x] Chunks have correct volume (2) based on PDF source\n- [x] Section IDs match NCC format (208 unique: A1G1, H1D3, S42C1, etc.)\n- [x] Each chunk has a 768-dimension embedding (gemini-embedding-001)\n- [x] Dry-run mode prints chunks without calling APIs\n- [x] Data appears in Supabase ncc_chunks table (363 rows)\n- [x] match_ncc_chunks returns relevant results for test queries (ceiling height -\u003e H4F2 at 0.735, egress -\u003e A6G2 at 0.694)\n\n## Key Details\n- Used gemini-embedding-001 (not text-embedding-004 which is deprecated/removed from API)\n- TOC-based chunking with hair-space section ID markers for precise within-page splitting\n- 208 unique sections, 363 total chunks (long sections split at paragraph boundaries)\n- Average chunk size 1016 chars, max 2000 chars, min 42 chars\n- Rate limit retry logic handles Gemini free tier 429s with exponential backoff\n- State appendices (Schedules 4-11, p.216-312) skipped per POC scope\n- Schedules 1-3 (definitions/references) excluded from chunking","created_at":"2026-02-20T02:29:51Z"},{"id":4,"issue_id":"buildscope-tde.1.2","author":"thebrownproject","text":"[INSPECTOR] Review complete\n\n[REQUIREMENTS:PASS] All test criteria met (7/7)\n[QUALITY:PASS] Clean, concise implementation\n\n## Requirements Verification\n\n1. Script runs without errors on NCC PDFs -- PASS (363 chunks, dry-run clean)\n2. Chunks have correct volume based on PDF source -- PASS (all 363 rows volume=2)\n3. Section IDs match NCC format -- PASS (208 unique, all match [A-Z][0-9]+[A-Z]+[0-9]+ or S[0-9]+C[0-9]+)\n4. Each chunk has a 768-dimension embedding -- PASS (vector_dims confirmed 768)\n5. Dry-run mode prints chunks without calling APIs -- PASS (returns before load_env, no API calls)\n6. Data appears in Supabase ncc_chunks table -- PASS (363 rows, zero null sections)\n7. match_ncc_chunks returns relevant results -- PASS (H4F2 query returns room-height sections at 0.809-1.000 similarity)\n\n## Quality Notes\n\nGemini API usage verified against current SDK docs (Context7). embed_content call pattern is correct.\nScript is 349 lines with no bloat, no unnecessary abstractions, no DRY violations.\nEmbedding model change (text-embedding-004 -\u003e gemini-embedding-001) is correct per deprecation.\n\n[BUG:info] VERSION_ANNO_RE cleanup incomplete: [New for 2022] annotations survive in stored content (e.g. chunk id=5,6,7). Regex runs per-page but annotations survive section extraction. Cosmetic only, does not harm RAG retrieval.\n[BUG:info] Missing ingestion/.env.example per task spec. Root .env.example covers all vars. Functionally equivalent.\n[BUG:info] MIN_CHUNK_CHARS=50 not enforced on naturally short sections (min in DB is 42 chars). Acceptable for POC.","created_at":"2026-02-20T02:33:33Z"}]}
{"id":"buildscope-tde.1.3","title":"Deploy Supabase Edge Function for RAG queries","description":"**Goal:** Create and deploy a TypeScript/Deno Edge Function that receives a question + project context, runs vector search with metadata filtering, calls Gemini LLM with retrieved chunks, and returns an answer with NCC section references.\n\n**Files:**\n- Supabase Edge Function: ncc-query (deployed via MCP)\n\n**API Contract:**\n- Request: { question, context: { building_class, state, construction_type }, chat_history? }\n- Response: { answer, references: [{ section, title }] }\n\n**Steps:**\n1. Implement Edge Function with POST handler and input validation\n2. Embed query via Gemini text-embedding-004 REST API\n3. pgvector search via supabase.rpc(\"match_ncc_chunks\") with volume + class filtering\n4. Build system prompt injecting project context and NCC citation format\n5. Call Gemini 2.0 Flash with chunks + system prompt + chat history\n6. Extract structured references from answer text\n7. Return { answer, references }\n8. Deploy with verify_jwt: true\n9. Test with curl for different building classes\n10. Document API contract for C# service\n\n**Tests:**\n- [ ] Edge Function deploys without errors\n- [ ] POST with valid body returns { answer, references }\n- [ ] POST with missing fields returns 400\n- [ ] Answer contains bold NCC section references\n- [ ] Class 1 query retrieves only Volume 2 chunks\n- [ ] Class 3 query retrieves only Volume 1 chunks\n- [ ] Response time under 10 seconds","status":"closed","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-20T11:06:29.857552+11:00","created_by":"thebrownproject","updated_at":"2026-02-20T13:55:43.906431+11:00","closed_at":"2026-02-20T13:55:43.906431+11:00","close_reason":"Edge Function ncc-query deployed (v8, ACTIVE). Handles POST with question + project context, embeds via gemini-embedding-001, pgvector search with class/volume filtering, Gemini 2.0 Flash LLM, returns {answer, references}. Input validation returns 400 for missing fields. CORS enabled. Live curl testing deferred due to Gemini rate limits from ingestion -- verify manually once limits reset.","dependencies":[{"issue_id":"buildscope-tde.1.3","depends_on_id":"buildscope-tde.1","type":"parent-child","created_at":"2026-02-20T11:06:29.85859+11:00","created_by":"thebrownproject"},{"issue_id":"buildscope-tde.1.3","depends_on_id":"buildscope-tde.1.1","type":"blocks","created_at":"2026-02-20T11:08:43.982539+11:00","created_by":"thebrownproject"},{"issue_id":"buildscope-tde.1.3","depends_on_id":"buildscope-tde.1.2","type":"blocks","created_at":"2026-02-20T11:08:44.082751+11:00","created_by":"thebrownproject"}],"comments":[{"id":5,"issue_id":"buildscope-tde.1.3","author":"thebrownproject","text":"[PATHFINDER] Codebase exploration complete\n\n## Codebase Context\n\n### Database Schema (confirmed live)\n- `ncc_chunks` table: 363 rows, all Volume 2, applicable_classes=[1,10]\n- Embedding dimension: 768 (verified via `vector_dims()`)\n- RLS enabled with `anon` SELECT policy (`true`) -- anon key can read all chunks\n- `match_ncc_chunks` RPC: SECURITY INVOKER, callable by anon/authenticated/service_role\n- RPC signature: `match_ncc_chunks(query_embedding vector, filter_volume smallint DEFAULT NULL, filter_class integer DEFAULT NULL, match_threshold float DEFAULT 0.7, match_count integer DEFAULT 8)`\n- RPC returns: `(id bigint, content text, section text, title text, part text, volume smallint, applicable_classes integer[], similarity float)`\n\n### Ingestion Script Reference (ingestion/ingest.py)\n- Lines 29-30: `EMBED_MODEL = \"gemini-embedding-001\"`, `EMBED_DIMS = 768`\n- Line 251-254: Uses `output_dimensionality=768`, no `taskType` specified during ingestion\n- Chunks were embedded without taskType -- Edge Function should use `RETRIEVAL_QUERY` for query embeddings (compatible with unchosen taskType documents)\n\n### No Existing Edge Functions\n- `list_edge_functions` returns empty array -- this is a fresh deployment\n\n## Gemini REST API Endpoints\n\n### Embedding (gemini-embedding-001)\n- URL: `https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:embedContent`\n- Auth header: `x-goog-api-key: ${GEMINI_API_KEY}`\n- Request body:\n```json\n{\n  \"content\": {\"parts\": [{\"text\": \"query text here\"}]},\n  \"taskType\": \"RETRIEVAL_QUERY\",\n  \"outputDimensionality\": 768\n}\n```\n- IMPORTANT: REST API uses camelCase `outputDimensionality` (NOT snake_case `output_dimensionality` which is Python SDK only)\n- Response (single text):\n```json\n{\n  \"embedding\": {\n    \"values\": [0.123, -0.456, ...]\n  }\n}\n```\n- Extract via: `response.embedding.values` (768-length float array)\n- Default dimension for gemini-embedding-001 is 3072 -- MUST specify `outputDimensionality: 768` to match DB vectors\n\n### LLM (gemini-2.0-flash)\n- URL: `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent`\n- Auth header: `x-goog-api-key: ${GEMINI_API_KEY}`\n- Request body:\n```json\n{\n  \"system_instruction\": {\n    \"parts\": [{\"text\": \"system prompt here\"}]\n  },\n  \"contents\": [\n    {\"role\": \"user\", \"parts\": [{\"text\": \"message 1\"}]},\n    {\"role\": \"model\", \"parts\": [{\"text\": \"response 1\"}]},\n    {\"role\": \"user\", \"parts\": [{\"text\": \"current question\"}]}\n  ]\n}\n```\n- Chat history: alternating user/model roles in `contents` array, final entry must be `user`\n- System prompt goes in `system_instruction`, NOT in `contents`\n- Response:\n```json\n{\n  \"candidates\": [{\n    \"content\": {\n      \"parts\": [{\"text\": \"answer text\"}],\n      \"role\": \"model\"\n    },\n    \"finishReason\": \"STOP\"\n  }]\n}\n```\n- Extract via: `response.candidates[0].content.parts[0].text`\n\n## Supabase Edge Function Patterns\n\n### Boilerplate structure\n```typescript\nimport { createClient } from \"npm:@supabase/supabase-js@2\"\n\nDeno.serve(async (req) =\u003e {\n  // CORS preflight\n  if (req.method === \"OPTIONS\") {\n    return new Response(\"ok\", { headers: corsHeaders })\n  }\n\n  const supabase = createClient(\n    Deno.env.get(\"SUPABASE_URL\")!,\n    Deno.env.get(\"SUPABASE_ANON_KEY\")!,\n    { global: { headers: { Authorization: req.headers.get(\"Authorization\")! } } }\n  )\n\n  // ... handler logic\n})\n```\n\n### Default env vars available (no setup needed)\n- `SUPABASE_URL` -- project API gateway URL\n- `SUPABASE_ANON_KEY` -- anon JWT key (respects RLS)\n- `SUPABASE_SERVICE_ROLE_KEY` -- bypasses RLS\n- `SUPABASE_DB_URL` -- direct Postgres connection\n\n### Custom secret\n- `GEMINI_API_KEY` -- already set as Edge Function secret\n\n### RPC call pattern\n```typescript\nconst { data, error } = await supabase.rpc(\"match_ncc_chunks\", {\n  query_embedding: embeddingArray,  // JSON array, supabase-js handles vector serialization\n  filter_volume: 2,\n  filter_class: 1,\n  match_threshold: 0.7,\n  match_count: 8\n})\n```\n\n### Deployment\n- Deploy via MCP `deploy_edge_function` tool\n- Function name: `ncc-query`\n- Set `verify_jwt: true` -- C# client sends anon key as `Authorization: Bearer \u003canon_key\u003e`\n- Invocation URL: `https://pibdfbmyhqxckqdeffjg.supabase.co/functions/v1/ncc-query`\n\n## API Contract (from spec)\n\n### Request\n```json\n{\n  \"question\": \"What insulation do I need for external walls?\",\n  \"context\": {\n    \"building_class\": \"1\",\n    \"state\": \"VIC\",\n    \"construction_type\": \"Type C\"\n  },\n  \"chat_history\": [\n    {\"role\": \"user\", \"content\": \"previous question\"},\n    {\"role\": \"assistant\", \"content\": \"previous answer\"}\n  ]\n}\n```\n- `chat_history` is optional\n- `building_class` values for POC (Volume 2 only): \"1\", \"1a\", \"10a\", \"10b\", \"10c\"\n\n### Response\n```json\n{\n  \"answer\": \"For a **Class 1** building in **Victoria**...\",\n  \"references\": [\n    {\"section\": \"H1V3\", \"title\": \"Thermal insulation\"},\n    {\"section\": \"H4V2\", \"title\": \"Condensation management\"}\n  ]\n}\n```\n\n### Error Response\n```json\n{\"error\": \"Missing required field: question\"}\n```\nStatus 400 for validation errors, 500 for internal errors.\n\n### Volume Mapping Logic\n- Classes \"1\", \"1a\", \"10a\", \"10b\", \"10c\" -\u003e filter_volume = 2\n- Classes \"2\"-\"9\" (and sub-types) -\u003e filter_volume = 1\n- POC scope is Volume 2 only, but implement the mapping for future Volume 1 support\n\n### Building Class to Integer Mapping (for filter_class RPC param)\n- \"1\" -\u003e 1, \"1a\" -\u003e 1, \"10a\" -\u003e 10, \"10b\" -\u003e 10, \"10c\" -\u003e 10\n- DB stores applicable_classes as int array [1, 10] -- the RPC uses `filter_class = any(applicable_classes)`\n\n## System Prompt Design\n\nThe system prompt should inject project context and instruct citation format. Based on the spec wireframes (spec.md lines 254-283), answers should:\n1. Reference building class and state inline (bold)\n2. Use **bold** for NCC section IDs inline (e.g., \"per **H1V3**\")\n3. Include a References footer with \"ss Section - Title\" format\n4. Be specific to the project context, not generic\n\nSuggested system prompt structure:\n```\nYou are an NCC (National Construction Code) compliance assistant for Australian buildings.\n\nProject context:\n- Building class: {building_class}\n- State/Territory: {state}\n- Type of construction: {construction_type}\n\nInstructions:\n- Answer questions about NCC compliance specific to the project context above\n- Always cite NCC sections using bold formatting: **SectionID**\n- At the end of your answer, include a \"References:\" section listing each cited section as: ss SectionID - Section Title\n- If the provided NCC excerpts do not contain enough information, say so clearly\n- Do not make up section numbers -- only cite sections from the provided excerpts\n- Be concise and practical\n\nNCC excerpts:\n{chunks formatted as: [SectionID] Title\\nContent}\n```\n\n## Risks\n\n- CRITICAL: Task description references \"text-embedding-004\" but this model was deprecated (shutdown Jan 14, 2026). Ingestion used gemini-embedding-001 with outputDimensionality=768. Edge Function MUST use gemini-embedding-001 with outputDimensionality: 768 to match. The task description should be treated as outdated on this point.\n- All 363 chunks have applicable_classes=[1,10] -- the filter_class parameter should use the integer part (1 or 10) extracted from the building class string. For classes \"1\" and \"1a\", use filter_class=1. For \"10a\",\"10b\",\"10c\", use filter_class=10.\n- POC has Volume 2 data only -- Volume 1 queries (classes 2-9) will return zero results. Edge Function should handle this gracefully with a message like \"No relevant NCC sections found for this building class.\"\n- The `part` column in chunks contains tab characters (e.g., \"Part A1\\tInterpreting the NCC\\t\") -- this is cosmetic but worth noting if part data is displayed.\n- Chat history conversion: C# client sends {role, content} but Gemini API expects {role, parts:[{text}]} with role \"model\" instead of \"assistant\". Edge Function must map between these formats.","created_at":"2026-02-20T02:39:07Z"}]}
{"id":"buildscope-tde.1.4","title":"Scaffold Revit add-in project from Archie Copilot","description":"**Goal:** Create BuildScope.sln/.csproj targeting net8.0-windows with WPF, port App.cs from Archie Copilot with new GUID and branding, remove IronPython, verify it builds and loads in Revit.\n\n**Files:**\n- Create: BuildScope.sln, BuildScope.csproj, BuildScope.addin, App.cs\n- Reference: references/archie-copilot/App.cs, .csproj, .addin\n\n**Steps:**\n1. Create BuildScope.sln and .csproj (net8.0-windows, UseWPF=true, x64)\n2. Reference RevitAPI.dll and RevitAPIUI.dll (Private=False)\n3. Add Newtonsoft.Json NuGet. No IronPython\n4. Port App.cs: IExternalApplication, new namespace, new GUID, \"BuildScope\" ribbon tab\n5. Remove RevitCommandHandler and all IronPython/ExternalEvent code\n6. Create BuildScope.addin manifest with unique AddInId\n7. Create placeholder ChatPanel (empty WPF Page + IDockablePaneProvider)\n8. Build and verify in Revit\n\n**Tests:**\n- [ ] Project builds with dotnet build\n- [ ] .addin has unique GUID (not Archie's)\n- [ ] No IronPython dependency\n- [ ] Ribbon tab shows \"BuildScope\" with toggle button\n- [ ] Side panel opens in Revit","status":"open","priority":1,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-20T11:06:41.842895+11:00","created_by":"thebrownproject","updated_at":"2026-02-20T11:06:41.842895+11:00","dependencies":[{"issue_id":"buildscope-tde.1.4","depends_on_id":"buildscope-tde.1","type":"parent-child","created_at":"2026-02-20T11:06:41.844176+11:00","created_by":"thebrownproject"}]}
{"id":"buildscope-tde.1.5","title":"Build models and services layer","description":"**Goal:** Create all C# models (ChatMessage, ProjectContext) and services (Config, BuildScopeService, ProjectManager) that power the add-in.\n\n**Files:**\n- Create: Models/ChatMessage.cs, Models/ProjectContext.cs\n- Create: Services/Config.cs, Services/BuildScopeService.cs, Services/ProjectManager.cs\n\n**Steps:**\n1. ChatMessage.cs: MessageType enum (User, Assistant, Welcome, Loading), Content, References list, Timestamp\n2. ProjectContext.cs: Name, BuildingClass, State, ConstructionType\n3. Config.cs: Supabase URL + API key from env vars or config.json, Save/Load\n4. BuildScopeService.cs: HTTP POST to Edge Function, deserialize { answer, references }\n5. ProjectManager.cs: CRUD for project JSON files in AppData/BuildScope/Projects/, current project tracking\n\n**Tests:**\n- [ ] Config reads/saves Supabase URL and API key\n- [ ] BuildScopeService sends correct POST matching Edge Function contract\n- [ ] BuildScopeService deserializes answer and references\n- [ ] ProjectManager creates/lists/loads/deletes projects\n- [ ] Current project switching works\n- [ ] Error handling for HTTP and file I/O","status":"open","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-20T11:06:54.186825+11:00","created_by":"thebrownproject","updated_at":"2026-02-20T11:06:54.186825+11:00","dependencies":[{"issue_id":"buildscope-tde.1.5","depends_on_id":"buildscope-tde.1","type":"parent-child","created_at":"2026-02-20T11:06:54.188449+11:00","created_by":"thebrownproject"},{"issue_id":"buildscope-tde.1.5","depends_on_id":"buildscope-tde.1.4","type":"blocks","created_at":"2026-02-20T11:08:44.185761+11:00","created_by":"thebrownproject"},{"issue_id":"buildscope-tde.1.5","depends_on_id":"buildscope-tde.1.3","type":"blocks","created_at":"2026-02-20T11:08:44.292517+11:00","created_by":"thebrownproject"}]}
{"id":"buildscope-tde.1.6","title":"Build all views (ChatPanel, ProjectForm, SettingsPanel)","description":"**Goal:** Create the complete WPF UI: ChatPanel with markdown rendering and references footer, ProjectForm with class/state/type dropdowns, SettingsPanel for config, and project selector dropdown.\n\n**Files:**\n- Create/modify: Views/ChatPanel.xaml, Views/ChatPanel.xaml.cs\n- Create: Views/ProjectForm.xaml, Views/ProjectForm.xaml.cs\n- Create: Views/SettingsPanel.xaml, Views/SettingsPanel.xaml.cs\n\n**Steps:**\n1. Port ChatPanel.xaml from Archie: \"BuildScope\" header + gear icon, project dropdown bar, remove Code/Result templates, keep User/Assistant/Loading/Welcome\n2. Add markdown rendering: bold (**text**), bullet lists, section headers\n3. Add References footer: separator + \"References:\" + list of \"§ Section - Title\"\n4. ProjectForm: Name TextBox, Class dropdown (1,1a,2,3,4,5,6,7a,7b,8,9a,9b,9c,10a,10b,10c), State dropdown (NSW,VIC,QLD,SA,WA,TAS,NT,ACT), Type dropdown (A,B,C), Cancel/Create buttons\n5. SettingsPanel: Supabase URL, API Key, Save, back arrow\n6. Wire navigation between views\n\n**Tests:**\n- [ ] Panel renders with BuildScope header and gear icon\n- [ ] Project dropdown shows projects with context\n- [ ] Welcome screen on first run with New Project button\n- [ ] ProjectForm has correct dropdown options\n- [ ] Creating project navigates to chat\n- [ ] SettingsPanel loads/saves config\n- [ ] Markdown rendering works (bold, lists)\n- [ ] References footer displays correctly","status":"open","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-20T11:07:07.394919+11:00","created_by":"thebrownproject","updated_at":"2026-02-20T11:07:07.394919+11:00","dependencies":[{"issue_id":"buildscope-tde.1.6","depends_on_id":"buildscope-tde.1","type":"parent-child","created_at":"2026-02-20T11:07:07.39627+11:00","created_by":"thebrownproject"},{"issue_id":"buildscope-tde.1.6","depends_on_id":"buildscope-tde.1.5","type":"blocks","created_at":"2026-02-20T11:08:44.399371+11:00","created_by":"thebrownproject"}]}
{"id":"buildscope-tde.1.7","title":"Wire up end-to-end chat flow","description":"**Goal:** Connect all pieces: ChatPanel sends questions with project context to BuildScopeService, renders responses with markdown and references, manages per-project session memory, handles project switching and errors.\n\n**Files:**\n- Modify: Views/ChatPanel.xaml.cs, Services/BuildScopeService.cs\n\n**Steps:**\n1. Wire send button: add user message, show loading, call BuildScopeService.QueryAsync\n2. On response: remove loading, add assistant message with references, auto-scroll\n3. Per-project chat memory: Dictionary\u003cstring, ObservableCollection\u003cChatMessage\u003e\u003e, cap 20 messages\n4. Project switching: load project chat or show welcome\n5. Error handling: missing config, network errors, empty results\n6. Send chat history (last 10 messages) with each request\n7. Test full loop: create project -\u003e ask question -\u003e get answer -\u003e follow-up\n\n**Tests:**\n- [ ] Question sends to Edge Function with correct context\n- [ ] Response renders with answer and references\n- [ ] 20-message cap with FIFO eviction\n- [ ] Project switching loads correct chat\n- [ ] Missing config shows helpful error\n- [ ] Network errors display gracefully\n- [ ] Full loop works end-to-end","status":"open","priority":2,"issue_type":"task","owner":"fraserbrown@live.com","created_at":"2026-02-20T11:07:17.767141+11:00","created_by":"thebrownproject","updated_at":"2026-02-20T11:07:17.767141+11:00","dependencies":[{"issue_id":"buildscope-tde.1.7","depends_on_id":"buildscope-tde.1","type":"parent-child","created_at":"2026-02-20T11:07:17.768434+11:00","created_by":"thebrownproject"},{"issue_id":"buildscope-tde.1.7","depends_on_id":"buildscope-tde.1.6","type":"blocks","created_at":"2026-02-20T11:08:44.516187+11:00","created_by":"thebrownproject"}]}
