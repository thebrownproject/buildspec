<UserControl x:Class="BuildScope.Views.ChatPanel"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             Background="#F5F1EB">

    <UserControl.Resources>
        <!-- Palette -->
        <Color x:Key="BrandColor">#2B4D3F</Color>
        <Color x:Key="BrandHoverColor">#3A6650</Color>
        <Color x:Key="BrandMutedColor">#D1E0D8</Color>
        <Color x:Key="BackgroundColor">#F5F1EB</Color>
        <Color x:Key="SurfaceColor">#FFFFFF</Color>
        <Color x:Key="SurfaceDimColor">#EFEBE5</Color>
        <Color x:Key="BorderColor">#E2DDD6</Color>
        <Color x:Key="BorderStrongColor">#D0C9C0</Color>
        <Color x:Key="TextColor">#1A1A1A</Color>
        <Color x:Key="TextSecondaryColor">#6B6B6B</Color>
        <Color x:Key="TextMutedColor">#9B9B9B</Color>
        <Color x:Key="WarmAccentColor">#C4956A</Color>

        <SolidColorBrush x:Key="Brand" Color="{StaticResource BrandColor}" />
        <SolidColorBrush x:Key="BrandHover" Color="{StaticResource BrandHoverColor}" />
        <SolidColorBrush x:Key="BrandMuted" Color="{StaticResource BrandMutedColor}" />
        <SolidColorBrush x:Key="Background" Color="{StaticResource BackgroundColor}" />
        <SolidColorBrush x:Key="Surface" Color="{StaticResource SurfaceColor}" />
        <SolidColorBrush x:Key="SurfaceDim" Color="{StaticResource SurfaceDimColor}" />
        <SolidColorBrush x:Key="BorderBrush" Color="{StaticResource BorderColor}" />
        <SolidColorBrush x:Key="BorderStrong" Color="{StaticResource BorderStrongColor}" />
        <SolidColorBrush x:Key="Text" Color="{StaticResource TextColor}" />
        <SolidColorBrush x:Key="TextSecondary" Color="{StaticResource TextSecondaryColor}" />
        <SolidColorBrush x:Key="TextMuted" Color="{StaticResource TextMutedColor}" />
        <SolidColorBrush x:Key="WarmAccent" Color="{StaticResource WarmAccentColor}" />

        <!-- User message: sage green bubble, right-aligned -->
        <DataTemplate x:Key="UserMessageTemplate">
            <StackPanel Margin="48,6,16,6" HorizontalAlignment="Right">
                <Border CornerRadius="16,16,4,16" Padding="16,12" Background="{StaticResource Brand}">
                    <TextBlock Text="{Binding Content}" Foreground="White" TextWrapping="Wrap"
                               FontSize="13.5" LineHeight="20" FontFamily="Segoe UI" />
                </Border>
                <TextBlock Text="{Binding Timestamp, StringFormat='{}{0:h:mm tt}'}"
                           Foreground="{StaticResource TextMuted}" FontSize="10"
                           HorizontalAlignment="Right" Margin="0,4,6,0" FontFamily="Segoe UI" />
            </StackPanel>
        </DataTemplate>

        <!-- Assistant message: white card, left-aligned -->
        <DataTemplate x:Key="AssistantMessageTemplate">
            <StackPanel Margin="16,6,48,6" HorizontalAlignment="Left">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>
                    <Border Grid.Column="0" Width="28" Height="28" CornerRadius="14"
                            Background="{StaticResource Brand}"
                            VerticalAlignment="Top" Margin="0,2,10,0">
                        <TextBlock Text="B" Foreground="White" FontSize="12" FontWeight="Bold"
                                   HorizontalAlignment="Center" VerticalAlignment="Center"
                                   FontFamily="Segoe UI" />
                    </Border>
                    <Border Grid.Column="1" Background="White" CornerRadius="4,16,16,16" Padding="16,12"
                            BorderBrush="{StaticResource BorderBrush}" BorderThickness="1">
                        <StackPanel>
                            <StackPanel x:Name="MarkdownContent" Loaded="MarkdownContent_Loaded" />
                            <StackPanel x:Name="ReferencesPanel" Loaded="ReferencesPanel_Loaded" />
                        </StackPanel>
                    </Border>
                </Grid>
                <TextBlock Text="{Binding Timestamp, StringFormat='{}{0:h:mm tt}'}"
                           Foreground="{StaticResource TextMuted}" FontSize="10"
                           HorizontalAlignment="Left" Margin="38,4,0,0" FontFamily="Segoe UI" />
            </StackPanel>
        </DataTemplate>

        <!-- Loading dots -->
        <DataTemplate x:Key="LoadingMessageTemplate">
            <StackPanel Margin="16,6,48,6" HorizontalAlignment="Left">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>
                    <Border Grid.Column="0" Width="28" Height="28" CornerRadius="14"
                            Background="{StaticResource Brand}"
                            VerticalAlignment="Top" Margin="0,2,10,0">
                        <TextBlock Text="B" Foreground="White" FontSize="12" FontWeight="Bold"
                                   HorizontalAlignment="Center" VerticalAlignment="Center"
                                   FontFamily="Segoe UI" />
                    </Border>
                    <Border Grid.Column="1" Background="White" CornerRadius="4,16,16,16" Padding="18,14"
                            BorderBrush="{StaticResource BorderBrush}" BorderThickness="1">
                        <StackPanel Orientation="Horizontal">
                            <Ellipse x:Name="Dot1" Width="7" Height="7" Fill="{StaticResource Brand}" Margin="0,0,6,0" Opacity="0.2" />
                            <Ellipse x:Name="Dot2" Width="7" Height="7" Fill="{StaticResource Brand}" Margin="0,0,6,0" Opacity="0.2" />
                            <Ellipse x:Name="Dot3" Width="7" Height="7" Fill="{StaticResource Brand}" Opacity="0.2" />
                        </StackPanel>
                        <Border.Triggers>
                            <EventTrigger RoutedEvent="Loaded">
                                <BeginStoryboard>
                                    <Storyboard RepeatBehavior="Forever">
                                        <DoubleAnimation Storyboard.TargetName="Dot1" Storyboard.TargetProperty="Opacity"
                                                         From="0.2" To="1.0" Duration="0:0:0.5" BeginTime="0:0:0"
                                                         AutoReverse="True" />
                                        <DoubleAnimation Storyboard.TargetName="Dot2" Storyboard.TargetProperty="Opacity"
                                                         From="0.2" To="1.0" Duration="0:0:0.5" BeginTime="0:0:0.15"
                                                         AutoReverse="True" />
                                        <DoubleAnimation Storyboard.TargetName="Dot3" Storyboard.TargetProperty="Opacity"
                                                         From="0.2" To="1.0" Duration="0:0:0.5" BeginTime="0:0:0.3"
                                                         AutoReverse="True" />
                                    </Storyboard>
                                </BeginStoryboard>
                            </EventTrigger>
                        </Border.Triggers>
                    </Border>
                </Grid>
            </StackPanel>
        </DataTemplate>

        <!-- Welcome screen: bold editorial style -->
        <DataTemplate x:Key="WelcomeMessageTemplate">
            <Border Margin="20,32,20,16" HorizontalAlignment="Stretch">
                <StackPanel HorizontalAlignment="Center" MaxWidth="280">
                    <!-- Logo circle -->
                    <Border Width="56" Height="56" CornerRadius="28" HorizontalAlignment="Center" Margin="0,0,0,20">
                        <Border.Background>
                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                <GradientStop Color="#2B4D3F" Offset="0" />
                                <GradientStop Color="#3A6650" Offset="1" />
                            </LinearGradientBrush>
                        </Border.Background>
                        <TextBlock Text="B" Foreground="White" FontSize="24" FontWeight="Bold"
                                   HorizontalAlignment="Center" VerticalAlignment="Center"
                                   FontFamily="Segoe UI" />
                    </Border>

                    <!-- Bold heading -->
                    <TextBlock Text="BuildScope" Foreground="#1A1A1A" FontSize="28" FontWeight="Bold"
                               HorizontalAlignment="Center" Margin="0,0,0,6"
                               FontFamily="Segoe UI" />
                    <TextBlock Text="NCC compliance, right in Revit."
                               Foreground="#6B6B6B" FontSize="14" FontWeight="Normal"
                               HorizontalAlignment="Center" Margin="0,0,0,24"
                               FontFamily="Segoe UI" />

                    <!-- Description -->
                    <TextBlock Foreground="#9B9B9B" FontSize="12.5" TextWrapping="Wrap" TextAlignment="Center"
                               HorizontalAlignment="Center" MaxWidth="260" Margin="0,0,0,28"
                               FontFamily="Segoe UI" LineHeight="19"
                               Text="Ask questions about the National Construction Code and get answers with section references." />

                    <!-- CTA button: pill shape -->
                    <Button x:Name="NewProjectButton" Click="NewProject_Click"
                            Foreground="White" Padding="24,12"
                            FontSize="13.5" FontWeight="SemiBold" FontFamily="Segoe UI"
                            HorizontalAlignment="Center" Cursor="Hand" BorderThickness="0">
                        <Button.Content>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="New Project" VerticalAlignment="Center" />
                                <TextBlock Text="  &#x2192;" VerticalAlignment="Center" FontSize="15" />
                            </StackPanel>
                        </Button.Content>
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="Button">
                                            <Border x:Name="Bd" CornerRadius="20" Padding="{TemplateBinding Padding}"
                                                    Background="#2B4D3F">
                                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="Bd" Property="Background" Value="#3A6650" />
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </Button.Style>
                    </Button>
                </StackPanel>
            </Border>
        </DataTemplate>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Header: clean, warm -->
        <Border Grid.Row="0" Padding="16,12" Background="White"
                BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1">
            <DockPanel>
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Left" VerticalAlignment="Center">
                    <Border Width="24" Height="24" CornerRadius="6" Margin="0,0,10,0" VerticalAlignment="Center"
                            Background="{StaticResource Brand}">
                        <TextBlock Text="B" Foreground="White" FontSize="11" FontWeight="Bold"
                                   HorizontalAlignment="Center" VerticalAlignment="Center" FontFamily="Segoe UI" />
                    </Border>
                    <TextBlock Text="Build" Foreground="#1A1A1A" FontSize="15" FontWeight="Bold"
                               VerticalAlignment="Center" FontFamily="Segoe UI" />
                    <TextBlock Text="Scope" Foreground="#2B4D3F" FontSize="15" FontWeight="Normal"
                               VerticalAlignment="Center" FontFamily="Segoe UI" />
                </StackPanel>
                <Button x:Name="SettingsButton" Click="Settings_Click"
                        DockPanel.Dock="Right" Background="Transparent" Foreground="#9B9B9B"
                        FontSize="15" Padding="6,4" FontFamily="Segoe UI" VerticalAlignment="Center"
                        Content="&#x2699;" Cursor="Hand" BorderThickness="0">
                    <Button.Template>
                        <ControlTemplate TargetType="Button">
                            <Border Background="Transparent" Padding="{TemplateBinding Padding}" CornerRadius="8">
                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                            </Border>
                        </ControlTemplate>
                    </Button.Template>
                </Button>
            </DockPanel>
        </Border>

        <!-- Project selector -->
        <Border x:Name="ProjectBar" Grid.Row="1" Padding="12,8" Background="#EFEBE5"
                BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1">
            <ComboBox x:Name="ProjectDropdown" SelectionChanged="ProjectDropdown_SelectionChanged"
                      Background="White" Foreground="#1A1A1A" FontSize="12.5" FontFamily="Segoe UI"
                      BorderBrush="{StaticResource BorderBrush}" BorderThickness="1" Padding="10,6" />
        </Border>

        <!-- Messages area -->
        <ScrollViewer Grid.Row="2" x:Name="MessagesScroll" VerticalScrollBarVisibility="Auto"
                      Background="#F5F1EB" Padding="0,8">
            <ItemsControl x:Name="MessagesPanel" />
        </ScrollViewer>

        <!-- Input area -->
        <Border Grid.Row="3" Background="White" Padding="14,12"
                BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,1,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <Grid Grid.Column="0">
                    <TextBox x:Name="InputBox"
                             Background="#F5F1EB" Foreground="#1A1A1A" CaretBrush="#2B4D3F"
                             Padding="14,10" FontSize="13.5" BorderThickness="0"
                             AcceptsReturn="True" TextWrapping="Wrap"
                             MaxHeight="120" MinHeight="38" FontFamily="Segoe UI"
                             VerticalScrollBarVisibility="Auto"
                             KeyDown="InputBox_KeyDown" TextChanged="InputBox_TextChanged">
                        <TextBox.Style>
                            <Style TargetType="TextBox">
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="TextBox">
                                            <Border Background="{TemplateBinding Background}"
                                                    CornerRadius="12" Padding="{TemplateBinding Padding}"
                                                    BorderBrush="#E2DDD6" BorderThickness="1">
                                                <ScrollViewer x:Name="PART_ContentHost" />
                                            </Border>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </TextBox.Style>
                    </TextBox>
                    <TextBlock x:Name="PlaceholderText" Text="Ask about NCC compliance..."
                               Foreground="#9B9B9B" FontSize="13.5" FontFamily="Segoe UI"
                               IsHitTestVisible="False" VerticalAlignment="Center"
                               Margin="16,0,0,0" />
                </Grid>
                <Button x:Name="SendButton" Grid.Column="1" Click="Send_Click"
                        Padding="0" Margin="10,0,0,0" Cursor="Hand" BorderThickness="0"
                        VerticalAlignment="Bottom">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="Button">
                                        <Border x:Name="Bd" CornerRadius="12" Width="40" Height="40"
                                                Background="#2B4D3F">
                                            <Path Data="M6,0 L12,6 L8,6 L8,14 L4,14 L4,6 L0,6 Z"
                                                  Fill="White" HorizontalAlignment="Center" VerticalAlignment="Center"
                                                  RenderTransformOrigin="0.5,0.5">
                                                <Path.RenderTransform>
                                                    <RotateTransform Angle="0" />
                                                </Path.RenderTransform>
                                            </Path>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="Bd" Property="Background" Value="#3A6650" />
                                            </Trigger>
                                            <Trigger Property="IsEnabled" Value="False">
                                                <Setter TargetName="Bd" Property="Background" Value="#D0C9C0" />
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </Button.Style>
                </Button>
            </Grid>
        </Border>
    </Grid>
</UserControl>
