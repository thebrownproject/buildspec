<UserControl x:Class="BuildScope.Views.ChatPanel"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             Background="#1B1B1F">

    <UserControl.Resources>
        <Color x:Key="AccentColor">#D4944C</Color>
        <Color x:Key="AccentHoverColor">#E0A86A</Color>
        <Color x:Key="AccentDimColor">#A06B30</Color>
        <Color x:Key="SurfaceColor">#232328</Color>
        <Color x:Key="SurfaceElevatedColor">#2A2A30</Color>
        <Color x:Key="SurfaceHighColor">#35353D</Color>
        <Color x:Key="BorderSubtleColor">#3A3A42</Color>
        <Color x:Key="TextPrimaryColor">#EAEAEC</Color>
        <Color x:Key="TextSecondaryColor">#8E8E96</Color>

        <SolidColorBrush x:Key="Accent" Color="{StaticResource AccentColor}" />
        <SolidColorBrush x:Key="AccentHover" Color="{StaticResource AccentHoverColor}" />
        <SolidColorBrush x:Key="AccentDim" Color="{StaticResource AccentDimColor}" />
        <SolidColorBrush x:Key="Surface" Color="{StaticResource SurfaceColor}" />
        <SolidColorBrush x:Key="SurfaceElevated" Color="{StaticResource SurfaceElevatedColor}" />
        <SolidColorBrush x:Key="SurfaceHigh" Color="{StaticResource SurfaceHighColor}" />
        <SolidColorBrush x:Key="BorderSubtle" Color="{StaticResource BorderSubtleColor}" />
        <SolidColorBrush x:Key="TextPrimary" Color="{StaticResource TextPrimaryColor}" />
        <SolidColorBrush x:Key="TextSecondary" Color="{StaticResource TextSecondaryColor}" />

        <Style x:Key="PillButton" TargetType="Button">
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd" Background="{TemplateBinding Background}"
                                CornerRadius="6" Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- User message -->
        <DataTemplate x:Key="UserMessageTemplate">
            <StackPanel Margin="50,4,14,4" HorizontalAlignment="Right">
                <Border CornerRadius="14,14,4,14" Padding="14,10">
                    <Border.Background>
                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                            <GradientStop Color="#D4944C" Offset="0" />
                            <GradientStop Color="#B87A38" Offset="1" />
                        </LinearGradientBrush>
                    </Border.Background>
                    <TextBlock Text="{Binding Content}" Foreground="#FFFDF8" TextWrapping="Wrap"
                               FontSize="13.5" LineHeight="20" FontFamily="Segoe UI" />
                </Border>
                <TextBlock Text="{Binding Timestamp, StringFormat='{}{0:h:mm tt}'}"
                           Foreground="#5A5A62" FontSize="10"
                           HorizontalAlignment="Right" Margin="0,3,4,0" FontFamily="Segoe UI" />
            </StackPanel>
        </DataTemplate>

        <!-- Assistant message with markdown + references -->
        <DataTemplate x:Key="AssistantMessageTemplate">
            <StackPanel Margin="14,4,50,4" HorizontalAlignment="Left">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>
                    <Border Grid.Column="0" Width="26" Height="26" CornerRadius="13"
                            VerticalAlignment="Top" Margin="0,2,10,0">
                        <Border.Background>
                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                <GradientStop Color="#D4944C" Offset="0" />
                                <GradientStop Color="#A06B30" Offset="1" />
                            </LinearGradientBrush>
                        </Border.Background>
                        <TextBlock Text="B" Foreground="#FFFDF8" FontSize="12" FontWeight="Bold"
                                   HorizontalAlignment="Center" VerticalAlignment="Center"
                                   FontFamily="Segoe UI" />
                    </Border>
                    <Border Grid.Column="1" Background="#2A2A30" CornerRadius="4,14,14,14" Padding="14,10"
                            BorderBrush="#3A3A42" BorderThickness="1">
                        <StackPanel>
                            <!-- Markdown-rendered content -->
                            <StackPanel x:Name="MarkdownContent" Loaded="MarkdownContent_Loaded" />
                            <!-- References footer -->
                            <StackPanel x:Name="ReferencesPanel" Loaded="ReferencesPanel_Loaded" />
                        </StackPanel>
                    </Border>
                </Grid>
                <TextBlock Text="{Binding Timestamp, StringFormat='{}{0:h:mm tt}'}"
                           Foreground="#5A5A62" FontSize="10"
                           HorizontalAlignment="Left" Margin="36,3,0,0" FontFamily="Segoe UI" />
            </StackPanel>
        </DataTemplate>

        <!-- Loading indicator -->
        <DataTemplate x:Key="LoadingMessageTemplate">
            <StackPanel Margin="14,4,50,4" HorizontalAlignment="Left">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>
                    <Border Grid.Column="0" Width="26" Height="26" CornerRadius="13"
                            VerticalAlignment="Top" Margin="0,2,10,0">
                        <Border.Background>
                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                <GradientStop Color="#D4944C" Offset="0" />
                                <GradientStop Color="#A06B30" Offset="1" />
                            </LinearGradientBrush>
                        </Border.Background>
                        <TextBlock Text="B" Foreground="#FFFDF8" FontSize="12" FontWeight="Bold"
                                   HorizontalAlignment="Center" VerticalAlignment="Center"
                                   FontFamily="Segoe UI" />
                    </Border>
                    <Border Grid.Column="1" Background="#2A2A30" CornerRadius="4,14,14,14" Padding="16,12"
                            BorderBrush="#3A3A42" BorderThickness="1">
                        <StackPanel Orientation="Horizontal">
                            <Ellipse x:Name="Dot1" Width="7" Height="7" Fill="#D4944C" Margin="0,0,5,0" Opacity="0.25" />
                            <Ellipse x:Name="Dot2" Width="7" Height="7" Fill="#D4944C" Margin="0,0,5,0" Opacity="0.25" />
                            <Ellipse x:Name="Dot3" Width="7" Height="7" Fill="#D4944C" Opacity="0.25" />
                        </StackPanel>
                        <Border.Triggers>
                            <EventTrigger RoutedEvent="Loaded">
                                <BeginStoryboard>
                                    <Storyboard RepeatBehavior="Forever">
                                        <DoubleAnimation Storyboard.TargetName="Dot1" Storyboard.TargetProperty="Opacity"
                                                         From="0.25" To="1.0" Duration="0:0:0.5" BeginTime="0:0:0"
                                                         AutoReverse="True" />
                                        <DoubleAnimation Storyboard.TargetName="Dot2" Storyboard.TargetProperty="Opacity"
                                                         From="0.25" To="1.0" Duration="0:0:0.5" BeginTime="0:0:0.15"
                                                         AutoReverse="True" />
                                        <DoubleAnimation Storyboard.TargetName="Dot3" Storyboard.TargetProperty="Opacity"
                                                         From="0.25" To="1.0" Duration="0:0:0.5" BeginTime="0:0:0.3"
                                                         AutoReverse="True" />
                                    </Storyboard>
                                </BeginStoryboard>
                            </EventTrigger>
                        </Border.Triggers>
                    </Border>
                </Grid>
            </StackPanel>
        </DataTemplate>

        <!-- Welcome template -->
        <DataTemplate x:Key="WelcomeMessageTemplate">
            <Border Margin="14,20,14,10" HorizontalAlignment="Stretch">
                <StackPanel HorizontalAlignment="Center">
                    <Border Width="48" Height="48" CornerRadius="24" HorizontalAlignment="Center" Margin="0,0,0,14">
                        <Border.Background>
                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                <GradientStop Color="#D4944C" Offset="0" />
                                <GradientStop Color="#A06B30" Offset="1" />
                            </LinearGradientBrush>
                        </Border.Background>
                        <TextBlock Text="B" Foreground="#FFFDF8" FontSize="22" FontWeight="Bold"
                                   HorizontalAlignment="Center" VerticalAlignment="Center"
                                   FontFamily="Segoe UI" />
                    </Border>
                    <TextBlock Text="Welcome to" Foreground="#8E8E96" FontSize="13"
                               HorizontalAlignment="Center" FontFamily="Segoe UI" />
                    <TextBlock Text="BuildScope" Foreground="#EAEAEC" FontSize="18" FontWeight="Bold"
                               HorizontalAlignment="Center" Margin="0,2,0,12" FontFamily="Segoe UI" />
                    <TextBlock Foreground="#8E8E96" FontSize="12.5" TextWrapping="Wrap" TextAlignment="Center"
                               HorizontalAlignment="Center" MaxWidth="260" Margin="0,0,0,18" FontFamily="Segoe UI"
                               Text="Your NCC compliance assistant. Ask questions about the National Construction Code and get answers with section references." />
                    <Button x:Name="NewProjectButton" Content="+ New Project" Click="NewProject_Click"
                            Foreground="#FFFDF8" Padding="18,10"
                            FontSize="13" FontWeight="SemiBold" FontFamily="Segoe UI"
                            HorizontalAlignment="Center" Cursor="Hand" BorderThickness="0">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="Button">
                                            <Border x:Name="Bd" CornerRadius="8" Padding="{TemplateBinding Padding}">
                                                <Border.Background>
                                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                                        <GradientStop Color="#D4944C" Offset="0" />
                                                        <GradientStop Color="#B87A38" Offset="1" />
                                                    </LinearGradientBrush>
                                                </Border.Background>
                                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="Bd" Property="Background">
                                                        <Setter.Value>
                                                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                                                <GradientStop Color="#E0A86A" Offset="0" />
                                                                <GradientStop Color="#D4944C" Offset="1" />
                                                            </LinearGradientBrush>
                                                        </Setter.Value>
                                                    </Setter>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </Button.Style>
                    </Button>
                </StackPanel>
            </Border>
        </DataTemplate>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" Padding="14,9" Background="#232328"
                BorderBrush="#3A3A42" BorderThickness="0,0,0,1">
            <DockPanel>
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Left" VerticalAlignment="Center">
                    <Border Width="22" Height="22" CornerRadius="5" Margin="0,0,9,0" VerticalAlignment="Center">
                        <Border.Background>
                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                <GradientStop Color="#D4944C" Offset="0" />
                                <GradientStop Color="#A06B30" Offset="1" />
                            </LinearGradientBrush>
                        </Border.Background>
                        <TextBlock Text="B" Foreground="#FFFDF8" FontSize="11" FontWeight="Bold"
                                   HorizontalAlignment="Center" VerticalAlignment="Center" FontFamily="Segoe UI" />
                    </Border>
                    <TextBlock Text="Build" Foreground="#EAEAEC" FontSize="14.5" FontWeight="Bold"
                               VerticalAlignment="Center" FontFamily="Segoe UI" />
                    <TextBlock Text="Scope" Foreground="#D4944C" FontSize="14.5" FontWeight="Normal"
                               VerticalAlignment="Center" Margin="0,0,0,0" FontFamily="Segoe UI" />
                </StackPanel>
                <Button x:Name="SettingsButton" Click="Settings_Click"
                        DockPanel.Dock="Right" Background="Transparent" Foreground="#8E8E96"
                        FontSize="14" Padding="6,4" FontFamily="Segoe UI" VerticalAlignment="Center"
                        Content="&#x2699;" Style="{StaticResource PillButton}" />
            </DockPanel>
        </Border>

        <!-- Project selector bar -->
        <Border x:Name="ProjectBar" Grid.Row="1" Padding="10,7" Background="#1E1E22"
                BorderBrush="#3A3A42" BorderThickness="0,0,0,1">
            <ComboBox x:Name="ProjectDropdown" SelectionChanged="ProjectDropdown_SelectionChanged"
                      Background="#2A2A30" Foreground="#EAEAEC" FontSize="12" FontFamily="Segoe UI"
                      BorderBrush="#3A3A42" BorderThickness="1" Padding="8,5" />
        </Border>

        <!-- Messages -->
        <ScrollViewer Grid.Row="2" x:Name="MessagesScroll" VerticalScrollBarVisibility="Auto"
                      Background="#1B1B1F" Padding="0,6">
            <ItemsControl x:Name="MessagesPanel" />
        </ScrollViewer>

        <!-- Input area -->
        <Border Grid.Row="3" Background="#232328" Padding="12,10"
                BorderBrush="#3A3A42" BorderThickness="0,1,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <Grid Grid.Column="0">
                    <TextBox x:Name="InputBox"
                             Background="#2A2A30" Foreground="#EAEAEC" CaretBrush="#D4944C"
                             Padding="12,9" FontSize="13.5" BorderThickness="0"
                             AcceptsReturn="True" TextWrapping="Wrap"
                             MaxHeight="120" MinHeight="36" FontFamily="Segoe UI"
                             VerticalScrollBarVisibility="Auto"
                             KeyDown="InputBox_KeyDown" TextChanged="InputBox_TextChanged">
                        <TextBox.Style>
                            <Style TargetType="TextBox">
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="TextBox">
                                            <Border Background="{TemplateBinding Background}"
                                                    CornerRadius="8" Padding="{TemplateBinding Padding}"
                                                    BorderBrush="#3A3A42" BorderThickness="1">
                                                <ScrollViewer x:Name="PART_ContentHost" />
                                            </Border>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </TextBox.Style>
                    </TextBox>
                    <TextBlock x:Name="PlaceholderText" Text="Ask about NCC..."
                               Foreground="#5A5A62" FontSize="13.5" FontFamily="Segoe UI"
                               IsHitTestVisible="False" VerticalAlignment="Center"
                               Margin="14,0,0,0" />
                </Grid>
                <Button x:Name="SendButton" Grid.Column="1" Click="Send_Click"
                        Padding="12,8" Margin="8,0,0,0" Cursor="Hand" BorderThickness="0"
                        VerticalAlignment="Bottom">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="Button">
                                        <Border x:Name="Bd" CornerRadius="8" Padding="{TemplateBinding Padding}" Width="38" Height="38">
                                            <Border.Background>
                                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                    <GradientStop Color="#D4944C" Offset="0" />
                                                    <GradientStop Color="#B87A38" Offset="1" />
                                                </LinearGradientBrush>
                                            </Border.Background>
                                            <Path Data="M6,0 L12,6 L8,6 L8,14 L4,14 L4,6 L0,6 Z"
                                                  Fill="#FFFDF8" HorizontalAlignment="Center" VerticalAlignment="Center"
                                                  RenderTransformOrigin="0.5,0.5">
                                                <Path.RenderTransform>
                                                    <RotateTransform Angle="0" />
                                                </Path.RenderTransform>
                                            </Path>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="Bd" Property="Background">
                                                    <Setter.Value>
                                                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                            <GradientStop Color="#E0A86A" Offset="0" />
                                                            <GradientStop Color="#D4944C" Offset="1" />
                                                        </LinearGradientBrush>
                                                    </Setter.Value>
                                                </Setter>
                                            </Trigger>
                                            <Trigger Property="IsEnabled" Value="False">
                                                <Setter TargetName="Bd" Property="Background">
                                                    <Setter.Value>
                                                        <SolidColorBrush Color="#3A3A42" />
                                                    </Setter.Value>
                                                </Setter>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </Button.Style>
                </Button>
            </Grid>
        </Border>

        <!-- Footer -->
        <Border Grid.Row="4" Background="#1B1B1F" Padding="0,4,0,5">
            <TextBlock Text="Shift+Enter for new line" Foreground="#3A3A42"
                       FontSize="9.5" HorizontalAlignment="Center" FontFamily="Segoe UI" />
        </Border>
    </Grid>
</UserControl>
